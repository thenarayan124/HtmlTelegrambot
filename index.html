<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch & Earn</title>
    <script src='//libtl.com/sdk.js' data-zone='9565874' data-sdk='show_9565874'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: white;
        }
        .container {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .balance-card {
            background: linear-gradient(135deg, rgba(43,88,118,0.8) 0%, rgba(78,67,118,0.8) 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .balance-amount {
            font-size: 28px;
            font-weight: bold;
            color: #f8c537;
        }
        .btn {
            background: linear-gradient(135deg, #3a7bd5 0%, #00d2ff 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="balance-card">
            <h2>Your Balance</h2>
            <div class="balance-amount">
                ₹<span id="balance">0.00</span>
            </div>
        </div>
        
        <button class="btn" id="watchAdBtn">Watch Ad (₹0.50)</button>
        <button class="btn" id="withdrawBtn">Withdraw Money</button>
        <button class="btn" id="referBtn">Refer & Earn</button>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // User Data Management
        const userData = {
            init() {
                this.userId = this.getUserId();
                this.loadData();
                this.checkReferral();
            },
            
            getUserId() {
                if (window.Telegram && window.Telegram.WebApp) {
                    return 'tg_' + window.Telegram.WebApp.initDataUnsafe.user.id;
                }
                let userId = localStorage.getItem('localUserId');
                if (!userId) {
                    userId = 'local_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('localUserId', userId);
                }
                return userId;
            },
            
            loadData() {
                const allData = JSON.parse(localStorage.getItem('earnAppData')) || {};
                if (!allData[this.userId]) {
                    allData[this.userId] = {
                        balance: 0,
                        withdrawals: [],
                        referrals: [],
                        earnings: []
                    };
                }
                this.data = allData[this.userId];
                this.allData = allData;
                this.updateUI();
            },
            
            saveData() {
                this.allData[this.userId] = this.data;
                localStorage.setItem('earnAppData', JSON.stringify(this.allData));
                this.updateUI();
            },
            
            updateUI() {
                document.getElementById('balance').textContent = this.data.balance.toFixed(2);
            },
            
            checkReferral() {
                const urlParams = new URLSearchParams(window.location.search);
                const refCode = urlParams.get('ref');
                if (refCode && refCode.startsWith('ref_') && !localStorage.getItem('refProcessed_' + refCode)) {
                    const referrerId = refCode.split('_')[1];
                    if (referrerId !== this.userId && this.allData[referrerId]) {
                        this.allData[referrerId].balance += 0.50;
                        this.allData[referrerId].referrals.push({
                            referredUser: this.userId,
                            date: new Date().toISOString(),
                            earned: 0.50
                        });
                        this.data.balance += 0.50;
                        localStorage.setItem('refProcessed_' + refCode, 'true');
                        this.showNotification('Referral bonus added!');
                        this.saveData();
                    }
                }
            },
            
            showNotification(message) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.style.display = 'block';
                setTimeout(() => notification.style.display = 'none', 3000);
            }
        };

        // Initialize
        userData.init();

        // Event Listeners
        document.getElementById('watchAdBtn').addEventListener('click', () => {
            if (typeof show_9565874 === 'function') {
                show_9565874().then(() => {
                    userData.data.balance += 0.50;
                    userData.data.earnings.push({
                        amount: 0.50,
                        source: 'ad',
                        date: new Date().toISOString()
                    });
                    userData.saveData();
                    userData.showNotification('₹0.50 added to your balance!');
                });
            }
        });

        document.getElementById('withdrawBtn').addEventListener('click', () => {
            if (userData.data.balance < 100) {
                userData.showNotification(`Minimum withdrawal is ₹100 (₹${(100-userData.data.balance).toFixed(2)} more needed)`);
                return;
            }
            const upiId = prompt("Enter your UPI ID:");
            if (upiId) {
                userData.data.withdrawals.push({
                    amount: userData.data.balance,
                    upiId: upiId,
                    date: new Date().toISOString(),
                    status: 'Pending'
                });
                userData.data.balance = 0;
                userData.saveData();
                userData.showNotification('Withdrawal request submitted!');
            }
        });

        document.getElementById('referBtn').addEventListener('click', () => {
            const refLink = `https://yourwebsite.com/earn.html?ref=ref_${userData.userId}`;
            navigator.clipboard.writeText(refLink);
            userData.showNotification('Referral link copied to clipboard!');
        });
    </script>
</body>
</html>
